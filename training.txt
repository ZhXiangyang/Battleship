from keras.constraints import max_norm
from keras import regularizers
 
dense_layer = 0
layer_size = 128
conv_layer = 2
METRICS = [
      keras.metrics.TruePositives(name='TruePositives'),
      keras.metrics.FalsePositives(name='FalsePositive'),
      keras.metrics.TrueNegatives(name='TrueNegatives'),
      keras.metrics.FalseNegatives(name='FalseNegatives'), 
      keras.metrics.BinaryAccuracy(name='accuracy'),
      keras.metrics.Precision(name='precision'),
      keras.metrics.Recall(name='recall'),
      keras.metrics.AUC(name='auc'),
]

 
 
NAME = "lenX: {} - {}-conv-{}-nodes-{}-dense-{}".format(len(x),conv_layer, layer_size, dense_layer, int(time.time()))
print(NAME)
 
model = Sequential()
 
model.add(Conv2D(layer_size, (3, 3) ,input_shape=X.shape[1:]))
model.add(Activation('relu'))
model.add(MaxPooling2D(pool_size=(2, 2)))

model.add(Conv2D(layer_size, (3, 3),kernel_constraint=max_norm(3),bias_constraint=max_norm(3),kernel_regularizer=regularizers.l2(l=0.01)))
 
model.add(Activation('relu'))
model.add(MaxPooling2D(pool_size=(2, 2)))

model.add(Flatten())
 
for _ in range(dense_layer):
  model.add(Dense(layer_size))
  model.add(Activation('relu'))
 
model.add(Dense(2))
model.add(Activation('sigmoid'))
 
tensorboard = TensorBoard(log_dir="/content/drive/MyDrive/Etudes/projet23/CNN_v3/logs/{}".format(NAME))
 
model.compile(loss='binary_crossentropy',
            optimizer='adam',
            metrics=METRICS,
            )
tf.keras.backend.clear_session() 
model.fit(x, y,
        batch_size=8,
        epochs=50,
        validation_split=0.3,
        callbacks=[tensorboard])

